<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.css" rel="stylesheet">
    <link href="/static/shared.css" rel="stylesheet">
    <style>
        /* 对话框布局优化 */
        .modal-body {
            padding: 1rem 1.5rem;
        }
        
        /* Tab Content Styling - 减少内容高度 */
        .tab-content {
            min-height: 300px;
        }
        
        .tab-pane {
            padding: 0.75rem 0;
        }
        
        /* 减少表单元素间距 */
        .tab-pane .mb-3 {
            margin-bottom: 0.75rem !important;
        }
        
        .tab-pane .mb-4 {
            margin-bottom: 1rem !important;
        }
        
        /* Advanced tab section headers */
        .tab-pane h6 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        /* Alert styling in advanced tab */
        .tab-pane .alert {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }
        
        /* Tab navigation styling */
        .nav-tabs .nav-link {
            border-bottom: 2px solid transparent;
            color: #6c757d;
        }
        
        .nav-tabs .nav-link.active {
            border-bottom: 2px solid #0d6efd;
            color: #0d6efd;
        }
        
        .nav-tabs .nav-link:hover {
            border-bottom: 2px solid #0d6efd;
            color: #0d6efd;
        }
        
        /* 确保认证值输入框高度一致 */
        #endpoint-auth-value {
            height: calc(1.5em + 0.75rem + 2px) !important;
            resize: none;
        }
        
        /* 表单标签图标样式 */
        .form-label-icon {
            margin-right: 0.25rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    {{template "header.html" .}}

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">端点配置</h5>
                            <small class="text-muted">配置变更自动保存，实时生效</small>
                        </div>
                        <button class="btn btn-primary" onclick="showAddEndpointModal()">
                            <i class="fas fa-plus"></i> 添加端点
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- 特殊端点列表 -->
                        <div id="special-endpoints-section" class="mb-4" style="display: none;">
                            <h6 class="mb-3">
                                <i class="fas fa-star text-warning"></i> 特殊端点
                                <small class="text-muted ms-2">有特定标签的端点</small>
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th width="40"><i class="fas fa-arrows-alt" title="拖拽行来重新排序"></i></th>
                                            <th>优先级</th>
                                            <th>名称</th>
                                            <th>URL</th>
                                            <th>类型</th>
                                            <th>路径</th>
                                            <th>认证方式</th>
                                            <th>代理</th>
                                            <th>标签</th>
                                            <th>状态</th>
                                            <th>启用</th>
                                            <th width="160">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="special-endpoint-list">
                                        <!-- 特殊端点将被动态添加到这里 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 通用端点列表 -->
                        <div id="general-endpoints-section">
                            <h6 class="mb-3">
                                <i class="fas fa-globe text-info"></i> 通用端点
                                <small class="text-muted ms-2">支持所有请求类型的端点</small>
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th width="40"><i class="fas fa-arrows-alt" title="拖拽行来重新排序"></i></th>
                                            <th>优先级</th>
                                            <th>名称</th>
                                            <th>URL</th>
                                            <th>类型</th>
                                            <th>路径</th>
                                            <th>认证方式</th>
                                            <th>代理</th>
                                            <th>标签</th>
                                            <th>状态</th>
                                            <th>启用</th>
                                            <th width="160">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="general-endpoint-list">
                                        <!-- 通用端点将被动态添加到这里 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑端点模态框 -->
    <div class="modal fade" id="endpointModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="endpointModalTitle">添加端点</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="endpointForm">
                        <input type="hidden" id="endpoint-id" />
                        
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs mb-3" id="endpointModalTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic-tab-pane" 
                                        type="button" role="tab" aria-controls="basic-tab-pane" aria-selected="true">
                                    <i class="fas fa-cog"></i> 基本配置
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced-tab-pane" 
                                        type="button" role="tab" aria-controls="advanced-tab-pane" aria-selected="false">
                                    <i class="fas fa-sliders-h"></i> 高级配置
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="endpointModalTabContent">
                            <!-- Basic Configuration Tab -->
                            <div class="tab-pane fade show active" id="basic-tab-pane" role="tabpanel" aria-labelledby="basic-tab">
                                <!-- 第一行：名称和启用状态 -->
                                <div class="row mb-3">
                                    <div class="col-9">
                                        <label for="endpoint-name" class="form-label">
                                            <i class="fas fa-tag form-label-icon"></i>名称 <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="endpoint-name" required>
                                    </div>
                                    <div class="col-3">
                                        <h6 class="mb-2">
                                            <i class="fas fa-power-off form-label-icon"></i> 启用
                                        </h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="endpoint-enabled" checked>
                                            <label class="form-check-label" for="endpoint-enabled">
                                                启用此端点
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- 第二行：URL 和 Tags -->
                                <div class="row mb-3">
                                    <div class="col-8">
                                        <label for="endpoint-url" class="form-label">
                                            <i class="fas fa-link form-label-icon"></i>URL <span class="text-danger">*</span>
                                        </label>
                                        <input type="url" class="form-control" id="endpoint-url" required
                                               placeholder="https://api.example.com">
                                    </div>
                                    <div class="col-4">
                                        <label for="endpoint-tags" class="form-label">
                                            <i class="fas fa-tags form-label-icon"></i>标签
                                        </label>
                                        <input type="text" class="form-control" id="endpoint-tags" 
                                               placeholder="用逗号分隔">
                                        <small class="form-text text-muted">留空则为万能endpoint</small>
                                    </div>
                                </div>

                                <!-- 第三行：端点类型和路径前缀 -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <label for="endpoint-type" class="form-label">
                                            <i class="fas fa-cogs form-label-icon"></i>端点类型 <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="endpoint-type" required onchange="onEndpointTypeChange()">
                                            <option value="anthropic">Anthropic (Claude)</option>
                                            <option value="openai">OpenAI Compatible</option>
                                        </select>
                                        <small class="form-text text-muted">选择端点的API兼容类型</small>
                                    </div>
                                    <div class="col-6" id="path-prefix-group" style="display: none;">
                                        <label for="endpoint-path-prefix" class="form-label">
                                            <i class="fas fa-route form-label-icon"></i>路径前缀 <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="endpoint-path-prefix" 
                                               placeholder="/v1/chat/completions">
                                        <small class="form-text text-muted">OpenAI兼容端点的API路径</small>
                                    </div>
                                </div>

                                <!-- 第四行：认证方式和认证值 -->
                                <div class="row mb-3">
                                    <div class="col-4">
                                        <label for="endpoint-auth-type" class="form-label">
                                            <i class="fas fa-key form-label-icon"></i>认证方式 <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="endpoint-auth-type" required onchange="onAuthTypeChange()">
                                            <option value="api_key">API Key (x-api-key 请求头)</option>
                                            <option value="auth_token" selected>Auth Token (Authorization Bearer)</option>
                                        </select>
                                    </div>
                                    <div class="col-8">
                                        <label for="endpoint-auth-value" class="form-label">
                                            <i class="fas fa-shield-alt form-label-icon"></i>认证值 <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="endpoint-auth-value" required
                                                   placeholder="输入您的 API Key 或 Token">
                                            <button class="btn btn-outline-secondary" type="button" id="toggle-auth-visibility" onclick="toggleAuthVisibility()">
                                                <i class="fas fa-eye" id="auth-eye-icon"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced Configuration Tab -->
                            <div class="tab-pane fade" id="advanced-tab-pane" role="tabpanel" aria-labelledby="advanced-tab">
                                <!-- 代理配置区域 -->
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">
                                            <i class="fas fa-shield-alt"></i> 代理配置
                                        </h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="proxy-enabled">
                                            <label class="form-check-label" for="proxy-enabled">启用代理</label>
                                        </div>
                                    </div>
                                    
                                    <div id="proxy-config" style="display: none;">
                                        <small class="form-text text-muted mb-3 d-block">配置HTTP或SOCKS5代理以访问上游端点</small>
                                        
                                        <!-- 代理类型和地址 -->
                                        <div class="row mb-3">
                                            <div class="col-4">
                                                <label for="proxy-type" class="form-label">代理类型</label>
                                                <select class="form-select" id="proxy-type">
                                                    <option value="http">HTTP</option>
                                                    <option value="socks5">SOCKS5</option>
                                                </select>
                                            </div>
                                            <div class="col-8">
                                                <label for="proxy-address" class="form-label">代理地址</label>
                                                <input type="text" class="form-control" id="proxy-address" 
                                                       placeholder="127.0.0.1:1080">
                                                <small class="form-text text-muted">格式: 主机:端口</small>
                                            </div>
                                        </div>
                                        
                                        <!-- 代理认证 -->
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label for="proxy-username" class="form-label">用户名 (可选)</label>
                                                <input type="text" class="form-control" id="proxy-username" 
                                                       placeholder="代理认证用户名">
                                            </div>
                                            <div class="col-6">
                                                <label for="proxy-password" class="form-label">密码 (可选)</label>
                                                <input type="password" class="form-control" id="proxy-password" 
                                                       placeholder="代理认证密码">
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-info p-2">
                                            <small class="text-muted">
                                                <strong>说明：</strong><br>
                                                • 留空用户名和密码表示无需认证<br>
                                                • HTTP代理支持 CONNECT 方法用于HTTPS<br>
                                                • SOCKS5代理支持TCP连接代理
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- 模型重写配置区域 -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">
                                            <i class="fas fa-exchange-alt"></i> 模型重写配置
                                        </h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="model-rewrite-enabled">
                                            <label class="form-check-label" for="model-rewrite-enabled">启用模型重写</label>
                                        </div>
                                    </div>
                                    
                                    <div id="model-rewrite-rules" style="display: none;">
                                        <small class="form-text text-muted mb-3 d-block">配置规则将匹配的Claude模型重写为其他模型</small>
                                        
                                        <div id="rewrite-rules-list">
                                            <!-- 动态生成的规则列表 -->
                                        </div>
                                        
                                        <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="addRewriteRule()">
                                            <i class="fas fa-plus"></i> 添加规则
                                        </button>
                                        
                                        <div class="alert alert-info p-2">
                                            <small class="text-muted">
                                                <strong>预设模型模式：</strong><br>
                                                • Haiku系列: claude-*haiku*<br>
                                                • Sonnet系列: claude-*sonnet*<br>  
                                                • Opus系列: claude-*opus*<br>
                                                • 所有Claude: claude-*
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveEndpoint()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="/static/shared.js"></script>
    <script>
        let currentEndpoints = [];
        let editingEndpointName = null;
        let endpointModal = null;
        let originalAuthValue = '';  // 保存原始auth value
        let isAuthVisible = false;   // auth value是否可见

        document.addEventListener('DOMContentLoaded', function() {
            initializeCommonFeatures();
            endpointModal = new bootstrap.Modal(document.getElementById('endpointModal'));
            loadEndpoints();
            
            // Auto-refresh every 30 seconds (only status updates)
            setInterval(refreshEndpointStatus, 30000);
        });

        let specialSortableInstance = null;
        let generalSortableInstance = null;

        function initializeSortable() {
            // 销毁现有的sortable实例
            if (specialSortableInstance) {
                specialSortableInstance.destroy();
                specialSortableInstance = null;
            }
            if (generalSortableInstance) {
                generalSortableInstance.destroy();
                generalSortableInstance = null;
            }

            // 初始化特殊端点列表的拖拽排序
            const specialTbody = document.getElementById('special-endpoint-list');
            if (specialTbody && specialTbody.children.length > 0) {
                specialSortableInstance = new Sortable(specialTbody, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    group: 'special-endpoints', // 限制在特殊端点组内拖拽
                    onStart: function(evt) {
                        document.body.style.cursor = 'grabbing';
                    },
                    onEnd: function (evt) {
                        document.body.style.cursor = '';
                        reorderEndpoints();
                    }
                });
            }
            
            // 初始化通用端点列表的拖拽排序
            const generalTbody = document.getElementById('general-endpoint-list');
            if (generalTbody && generalTbody.children.length > 0) {
                generalSortableInstance = new Sortable(generalTbody, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    group: 'general-endpoints', // 限制在通用端点组内拖拽
                    onStart: function(evt) {
                        document.body.style.cursor = 'grabbing';
                    },
                    onEnd: function (evt) {
                        document.body.style.cursor = '';
                        reorderEndpoints();
                    }
                });
            }
        }

        function loadEndpoints() {
            fetch('/admin/api/endpoints')
                .then(response => response.json())
                .then(data => {
                    currentEndpoints = data.endpoints;
                    rebuildTable(currentEndpoints);
                })
                .catch(error => {
                    console.error('Failed to load endpoints:', error);
                    showAlert('Failed to load endpoints', 'danger');
                });
        }

        function refreshEndpointStatus() {
            fetch('/admin/api/endpoints')
                .then(response => response.json())
                .then(data => {
                    // Only update status and statistics, not the full table
                    data.endpoints.forEach(endpoint => {
                        // 尝试在特殊端点列表中查找
                        let row = document.querySelector(`#special-endpoint-list tr[data-endpoint-name="${endpoint.name}"]`);
                        if (!row) {
                            // 如果没找到，则在通用端点列表中查找
                            row = document.querySelector(`#general-endpoint-list tr[data-endpoint-name="${endpoint.name}"]`);
                        }
                        if (row) {
                            updateEndpointRowStatus(row, endpoint);
                        }
                    });
                })
                .catch(error => console.error('Failed to refresh endpoint status:', error));
        }

        function updateEndpointRowStatus(row, endpoint) {
            const statusCell = row.children[9]; // 调整索引：增加了代理列，原来是8，现在是9
            
            // Update status
            let statusBadge = '';
            if (endpoint.status === 'active') {
                statusBadge = '<span class="badge bg-success"><i class="fas fa-check-circle"></i> 活跃</span>';
            } else if (endpoint.status === 'inactive') {
                statusBadge = '<span class="badge bg-danger"><i class="fas fa-times-circle"></i> 不可用</span>';
            } else {
                statusBadge = '<span class="badge bg-warning"><i class="fas fa-clock"></i> 检测中</span>';
            }
            statusCell.innerHTML = statusBadge;
        }

        function refreshTable() {
            // 重新加载端点数据而不是刷新整个页面
            loadEndpoints();
        }

        // 提取域名，只显示域名部分，路径用...省略  
        function extractDomain(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.hostname;
            } catch (e) {
                return url; // 如果不是有效URL，返回原始内容
            }
        }
        
        // 截断路径，超过指定长度用...显示
        function truncatePath(path, maxLength = 10) {
            if (!path || path.length <= maxLength) {
                return path;
            }
            return path.substring(0, maxLength) + '...';
        }

        function rebuildTable(endpoints) {
            const specialTbody = document.getElementById('special-endpoint-list');
            const generalTbody = document.getElementById('general-endpoint-list');
            const specialSection = document.getElementById('special-endpoints-section');
            
            // 清空现有内容
            specialTbody.innerHTML = '';
            generalTbody.innerHTML = '';
            
            // 分离有标签和无标签的端点
            const specialEndpoints = endpoints.filter(endpoint => endpoint.tags && endpoint.tags.length > 0);
            const generalEndpoints = endpoints.filter(endpoint => !endpoint.tags || endpoint.tags.length === 0);
            
            // 显示/隐藏特殊端点区域
            if (specialEndpoints.length > 0) {
                specialSection.style.display = 'block';
            } else {
                specialSection.style.display = 'none';
            }
            
            // 创建端点行的函数
            function createEndpointRow(endpoint, index) {
                const row = document.createElement('tr');
                row.className = 'endpoint-row';
                row.setAttribute('data-endpoint-name', endpoint.name);
                
                // 构建状态徽章
                let statusBadge = '';
                if (endpoint.status === 'active') {
                    statusBadge = '<span class="badge bg-success"><i class="fas fa-check-circle"></i> 活跃</span>';
                } else if (endpoint.status === 'inactive') {
                    statusBadge = '<span class="badge bg-danger"><i class="fas fa-times-circle"></i> 不可用</span>';
                } else {
                    statusBadge = '<span class="badge bg-warning"><i class="fas fa-clock"></i> 检测中</span>';
                }
                
                // 构建启用状态徽章
                const enabledBadge = endpoint.enabled 
                    ? '<span class="badge bg-success"><i class="fas fa-toggle-on"></i> 已启用</span>'
                    : '<span class="badge bg-secondary"><i class="fas fa-toggle-off"></i> 已禁用</span>';
                
                // 构建端点类型徽章
                const endpointTypeBadge = endpoint.endpoint_type === 'openai' 
                    ? '<span class="badge bg-warning">openai</span>'
                    : '<span class="badge bg-primary">anthropic</span>';
                
                // 构建 URL 显示：只显示域名，完整 URL 在 title 中显示 
                const domainOnly = extractDomain(endpoint.url);
                const urlDisplay = `<code class="url-display" title="${endpoint.url}">${domainOnly}</code>`;
                
                // 构建路径显示：超过10个字符截断
                let pathDisplay;
                if (endpoint.endpoint_type === 'openai') {
                    const fullPath = endpoint.path_prefix || '';
                    const truncatedPath = truncatePath(fullPath, 10);
                    pathDisplay = `<code class="path-display" title="${fullPath}">${truncatedPath}</code>`;
                } else {
                    pathDisplay = '<span class="text-muted">/v1/messages</span>';
                }
                
                // 构建认证类型徽章
                const authTypeBadge = endpoint.auth_type === 'api_key' 
                    ? '<span class="badge bg-primary">api_key</span>'
                    : '<span class="badge bg-secondary">auth_token</span>';
                
                // 构建代理状态显示
                let proxyDisplay = '';
                if (endpoint.proxy && endpoint.proxy.type && endpoint.proxy.address) {
                    const proxyType = endpoint.proxy.type.toUpperCase();
                    const hasAuth = endpoint.proxy.username ? ' 🔐' : '';
                    proxyDisplay = `<span class="badge bg-warning" title="代理: ${endpoint.proxy.type}://${endpoint.proxy.address}">${proxyType}${hasAuth}</span>`;
                } else {
                    proxyDisplay = '<span class="text-muted">无</span>';
                }
                
                // 构建tags显示
                let tagsDisplay = '';
                if (endpoint.tags && endpoint.tags.length > 0) {
                    tagsDisplay = endpoint.tags.map(tag => `<span class="badge bg-info me-1 mb-1">${tag}</span>`).join('');
                } else {
                    tagsDisplay = '<span class="text-muted">通用</span>';
                }
                
                row.innerHTML = `
                    <td class="drag-handle text-center">
                        <i class="fas fa-arrows-alt text-muted"></i>
                    </td>
                    <td>
                        <span class="badge bg-info priority-badge">${endpoint.priority}</span>
                    </td>
                    <td><strong>${endpoint.name}</strong></td>
                    <td>${urlDisplay}</td>
                    <td>${endpointTypeBadge}</td>
                    <td>${pathDisplay}</td>
                    <td>${authTypeBadge}</td>
                    <td>${proxyDisplay}</td>
                    <td>${tagsDisplay}</td>
                    <td>${statusBadge}</td>
                    <td>${enabledBadge}</td>
                    <td class="action-buttons">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary btn-sm" 
                                    onclick="event.stopPropagation(); showEditEndpointModal('${endpoint.name}')"
                                    title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-info btn-sm" 
                                    onclick="event.stopPropagation(); copyEndpoint('${endpoint.name}')"
                                    title="复制">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" 
                                    onclick="event.stopPropagation(); deleteEndpoint('${endpoint.name}')"
                                    title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                return row;
            }
            
            // 添加特殊端点
            specialEndpoints.forEach((endpoint, index) => {
                const row = createEndpointRow(endpoint, index);
                specialTbody.appendChild(row);
            });
            
            // 添加通用端点
            generalEndpoints.forEach((endpoint, index) => {
                const row = createEndpointRow(endpoint, specialEndpoints.length + index);
                generalTbody.appendChild(row);
            });
            
            // 重新初始化拖拽排序
            initializeSortable();
        }

        function showAddEndpointModal() {
            editingEndpointName = null;
            originalAuthValue = '';
            isAuthVisible = false;
            
            document.getElementById('endpointModalTitle').textContent = '添加端点';
            document.getElementById('endpointForm').reset();
            document.getElementById('endpoint-enabled').checked = true;
            document.getElementById('endpoint-type').value = 'anthropic'; // 默认为 Anthropic
            document.getElementById('endpoint-tags').value = ''; // 清理tags字段
            
            // 设置端点类型并切换路径前缀显示
            onEndpointTypeChange();
            
            // 重置auth visibility
            resetAuthVisibility();
            
            // 清空代理配置
            loadProxyConfig(null);
            
            // 清空模型重写配置
            loadModelRewriteConfig(null);
            
            // 重置到基本配置tab
            resetModalTabs();
            
            endpointModal.show();
        }

        function showEditEndpointModal(endpointName) {
            const endpoint = currentEndpoints.find(ep => ep.name === endpointName);
            if (!endpoint) {
                showAlert('端点未找到', 'danger');
                return;
            }

            editingEndpointName = endpointName;
            originalAuthValue = endpoint.auth_value;
            isAuthVisible = false;
            
            document.getElementById('endpointModalTitle').textContent = '编辑端点';
            
            // Populate form
            document.getElementById('endpoint-name').value = endpoint.name;
            document.getElementById('endpoint-url').value = endpoint.url;
            document.getElementById('endpoint-type').value = endpoint.endpoint_type || 'anthropic';
            document.getElementById('endpoint-path-prefix').value = endpoint.path_prefix || '';
            document.getElementById('endpoint-auth-type').value = endpoint.auth_type;
            document.getElementById('endpoint-enabled').checked = endpoint.enabled;
            
            // 设置端点类型并切换路径前缀显示
            onEndpointTypeChange();
            
            // 设置tags字段
            const tagsValue = endpoint.tags && endpoint.tags.length > 0 ? endpoint.tags.join(', ') : '';
            document.getElementById('endpoint-tags').value = tagsValue;
            
            // 设置auth value为星号
            document.getElementById('endpoint-auth-value').value = '*'.repeat(Math.min(endpoint.auth_value.length, 50));
            document.getElementById('endpoint-auth-value').type = 'password'; // 确保是password类型
            document.getElementById('endpoint-auth-value').placeholder = '输入您的 API Key 或 Token';
            resetAuthVisibility();
            
            // 加载代理配置
            loadProxyConfig(endpoint.proxy);
            
            // 加载模型重写配置
            loadModelRewriteConfig(endpoint.model_rewrite);
            
            // 重置到基本配置tab
            resetModalTabs();
            
            endpointModal.show();
        }

        // 重置模态框tabs到基本配置
        function resetModalTabs() {
            // 重置tab状态
            const basicTab = document.getElementById('basic-tab');
            const advancedTab = document.getElementById('advanced-tab');
            const basicPane = document.getElementById('basic-tab-pane');
            const advancedPane = document.getElementById('advanced-tab-pane');
            
            // 激活基本配置tab
            basicTab.classList.add('active');
            basicTab.setAttribute('aria-selected', 'true');
            basicPane.classList.add('show', 'active');
            
            // 去激活高级配置tab
            advancedTab.classList.remove('active');
            advancedTab.setAttribute('aria-selected', 'false');
            advancedPane.classList.remove('show', 'active');
        }

        function toggleAuthVisibility() {
            const authValueField = document.getElementById('endpoint-auth-value');
            const eyeIcon = document.getElementById('auth-eye-icon');
            
            if (isAuthVisible) {
                // 隐藏：显示星号
                if (originalAuthValue) {
                    authValueField.value = '*'.repeat(Math.min(originalAuthValue.length, 50));
                }
                authValueField.type = 'password'; // 设置为password类型
                eyeIcon.className = 'fas fa-eye';
                isAuthVisible = false;
            } else {
                // 显示：显示真实值
                authValueField.value = originalAuthValue;
                authValueField.type = 'text'; // 设置为text类型
                eyeIcon.className = 'fas fa-eye-slash';
                isAuthVisible = true;
            }
        }

        function resetAuthVisibility() {
            const eyeIcon = document.getElementById('auth-eye-icon');
            eyeIcon.className = 'fas fa-eye';
            isAuthVisible = false;
        }

        function saveEndpoint() {
            const form = document.getElementById('endpointForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // 获取auth value的真实值
            let authValue = document.getElementById('endpoint-auth-value').value;
            if (!isAuthVisible && originalAuthValue && authValue.startsWith('*')) {
                // 如果显示的是星号且有原始值，使用原始值
                authValue = originalAuthValue;
            }

            // 解析tags字段
            const tagsInput = document.getElementById('endpoint-tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

            const data = {
                name: document.getElementById('endpoint-name').value,
                url: document.getElementById('endpoint-url').value,
                endpoint_type: document.getElementById('endpoint-type').value,
                path_prefix: document.getElementById('endpoint-path-prefix').value || '', // PathPrefix 可以为空
                auth_type: document.getElementById('endpoint-auth-type').value,
                auth_value: authValue,
                enabled: document.getElementById('endpoint-enabled').checked,
                tags: tags,
                proxy: collectProxyData() // 新增：收集代理配置
            };

            const isEditing = editingEndpointName !== null;
            const url = isEditing 
                ? `/admin/api/endpoints/${encodeURIComponent(editingEndpointName)}` 
                : '/admin/api/endpoints';
            const method = isEditing ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    // 保存成功后，如果有模型重写配置，也保存它
                    const modelRewriteConfig = collectModelRewriteData();
                    const endpointName = document.getElementById('endpoint-name').value;
                    
                    const saveModelRewrite = modelRewriteConfig 
                        ? saveModelRewriteConfig(endpointName, modelRewriteConfig)
                        : Promise.resolve();
                    
                    saveModelRewrite
                        .then(() => {
                            endpointModal.hide();
                            showAlert(data.message, 'success');
                            loadEndpoints(); // 重新加载数据而不是刷新页面
                        })
                        .catch(error => {
                            console.error('Failed to save model rewrite config:', error);
                            showAlert('端点保存成功，但模型重写配置保存失败: ' + error.message, 'warning');
                            endpointModal.hide();
                            loadEndpoints();
                        });
                }
            })
            .catch(error => {
                console.error('Failed to save endpoint:', error);
                showAlert('Failed to save endpoint', 'danger');
            });
        }

        function deleteEndpoint(endpointName) {
            if (!confirm(`确定要删除端点 "${endpointName}" 吗？`)) {
                return;
            }

            fetch(`/admin/api/endpoints/${encodeURIComponent(endpointName)}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    showAlert(data.message, 'success');
                    loadEndpoints(); // 重新加载数据而不是刷新页面
                }
            })
            .catch(error => {
                console.error('Failed to delete endpoint:', error);
                showAlert('Failed to delete endpoint', 'danger');
            });
        }

        function copyEndpoint(endpointName) {
            if (!confirm(`确定要复制端点 "${endpointName}" 吗？`)) {
                return;
            }

            fetch(`/admin/api/endpoints/${encodeURIComponent(endpointName)}/copy`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    showAlert(data.message, 'success');
                    loadEndpoints(); // 重新加载数据以显示新复制的端点
                }
            })
            .catch(error => {
                console.error('Failed to copy endpoint:', error);
                showAlert('Failed to copy endpoint', 'danger');
            });
        }

        function reorderEndpoints() {
            // 获取特殊端点的顺序
            const specialRows = document.querySelectorAll('#special-endpoint-list tr');
            const specialOrderedNames = Array.from(specialRows).map(row => row.dataset.endpointName);
            
            // 获取通用端点的顺序
            const generalRows = document.querySelectorAll('#general-endpoint-list tr');
            const generalOrderedNames = Array.from(generalRows).map(row => row.dataset.endpointName);
            
            // 合并顺序：特殊端点在前，通用端点在后
            const orderedNames = [...specialOrderedNames, ...generalOrderedNames];
            
            fetch('/admin/api/endpoints/reorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ordered_names: orderedNames
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'danger');
                    loadEndpoints(); // 重新加载以恢复顺序
                } else {
                    showAlert(data.message, 'success');
                    // 更新优先级显示，不需要重新加载整个表格
                    let priorityIndex = 1;
                    
                    // 更新特殊端点的优先级
                    specialRows.forEach((row) => {
                        const priorityBadge = row.querySelector('.priority-badge');
                        if (priorityBadge) {
                            priorityBadge.textContent = priorityIndex++;
                        }
                    });
                    
                    // 更新通用端点的优先级
                    generalRows.forEach((row) => {
                        const priorityBadge = row.querySelector('.priority-badge');
                        if (priorityBadge) {
                            priorityBadge.textContent = priorityIndex++;
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Failed to reorder endpoints:', error);
                showAlert('Failed to reorder endpoints', 'danger');
                loadEndpoints(); // 重新加载以恢复顺序
            });
        }

        // ===== Endpoint Type and Auth Type Functions =====
        
        function onEndpointTypeChange() {
            togglePathPrefixField();
            toggleAuthTypeForEndpointType();
        }
        
        function togglePathPrefixField() {
            const endpointType = document.getElementById('endpoint-type').value;
            const pathPrefixGroup = document.getElementById('path-prefix-group');
            const pathPrefixInput = document.getElementById('endpoint-path-prefix');
            
            if (endpointType === 'openai') {
                pathPrefixGroup.style.display = 'block';
                pathPrefixInput.required = true;
                if (!pathPrefixInput.value) {
                    pathPrefixInput.value = '/v1/chat/completions'; // 默认值
                }
            } else {
                pathPrefixGroup.style.display = 'none';
                pathPrefixInput.required = false;
                pathPrefixInput.value = ''; // 清空值
            }
        }
        
        function toggleAuthTypeForEndpointType() {
            const endpointType = document.getElementById('endpoint-type').value;
            const authTypeSelect = document.getElementById('endpoint-auth-type');
            
            if (endpointType === 'openai') {
                // OpenAI compatible endpoints use auth_token and cannot be changed
                authTypeSelect.value = 'auth_token';
                authTypeSelect.disabled = true;
            } else {
                // Anthropic endpoints can use either auth type, but default to auth_token
                authTypeSelect.disabled = false;
                if (!editingEndpointName) { // Only set default for new endpoints
                    authTypeSelect.value = 'auth_token';
                }
            }
        }
        
        function onAuthTypeChange() {
            // This function can be used for future auth type specific logic
            // Currently no additional logic needed
        }

        // ===== Modal Functions =====

        // 代理配置启用/禁用切换
        document.getElementById('proxy-enabled').addEventListener('change', function() {
            const proxyConfigDiv = document.getElementById('proxy-config');
            proxyConfigDiv.style.display = this.checked ? 'block' : 'none';
        });

        // 模型重写启用/禁用切换
        document.getElementById('model-rewrite-enabled').addEventListener('change', function() {
            const rulesDiv = document.getElementById('model-rewrite-rules');
            rulesDiv.style.display = this.checked ? 'block' : 'none';
        });

        // 添加重写规则
        function addRewriteRule(sourcePattern = '', targetModel = '') {
            const rulesList = document.getElementById('rewrite-rules-list');
            const ruleIndex = rulesList.children.length;
            
            const ruleDiv = document.createElement('div');
            ruleDiv.className = 'row mb-2 rewrite-rule';
            ruleDiv.innerHTML = `
                <div class="col-5">
                    <select class="form-select source-model-select" onchange="updateSourcePattern(${ruleIndex})">
                        <option value="">选择预设模型</option>
                        <option value="claude-*haiku*">Haiku 系列</option>
                        <option value="claude-*sonnet*">Sonnet 系列</option>
                        <option value="claude-*opus*">Opus 系列</option>
                        <option value="claude-*">所有 Claude</option>
                        <option value="custom">自定义通配符</option>
                    </select>
                    <input type="text" class="form-control mt-1 source-pattern-input" 
                           placeholder="通配符模式" value="${sourcePattern}" readonly>
                </div>
                <div class="col-5">
                    <input type="text" class="form-control target-model-input" 
                           placeholder="目标模型 (如: deepseek-chat)" value="${targetModel}">
                    <small class="text-muted">推荐: deepseek-chat</small>
                </div>
                <div class="col-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRewriteRule(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm mt-1" onclick="testRewriteRule(${ruleIndex})" title="测试规则">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
            `;
            
            rulesList.appendChild(ruleDiv);
        }

        // 更新源模式输入框
        function updateSourcePattern(ruleIndex) {
            const ruleDiv = document.querySelectorAll('.rewrite-rule')[ruleIndex];
            const select = ruleDiv.querySelector('.source-model-select');
            const input = ruleDiv.querySelector('.source-pattern-input');
            
            if (select.value === 'custom') {
                input.readOnly = false;
                input.focus();
            } else {
                input.readOnly = true;
                input.value = select.value;
            }
        }

        // 移除重写规则
        function removeRewriteRule(button) {
            button.closest('.rewrite-rule').remove();
        }

        // 测试重写规则
        function testRewriteRule(ruleIndex) {
            const testModel = prompt('请输入要测试的模型名称:', 'claude-3-haiku-20240307');
            if (!testModel) return;

            if (!editingEndpointName) {
                alert('请先保存端点后再测试规则');
                return;
            }

            fetch(`/admin/api/endpoints/${encodeURIComponent(editingEndpointName)}/test-model-rewrite`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ test_model: testModel })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`测试失败: ${data.error}`);
                } else {
                    const message = data.rewrite_applied 
                        ? `✅ 重写生效!\n原模型: ${data.original_model}\n重写为: ${data.rewritten_model}\n匹配规则: ${data.matched_rule}`
                        : `❌ 无重写\n模型: ${data.original_model}\n未匹配任何规则`;
                    alert(message);
                }
            })
            .catch(error => {
                console.error('Test failed:', error);
                alert('测试失败，请检查网络连接');
            });
        }

        // 收集代理配置数据
        function collectProxyData() {
            const enabled = document.getElementById('proxy-enabled').checked;
            if (!enabled) {
                return null;
            }

            const type = document.getElementById('proxy-type').value;
            const address = document.getElementById('proxy-address').value.trim();
            const username = document.getElementById('proxy-username').value.trim();
            const password = document.getElementById('proxy-password').value.trim();
            
            if (!address) {
                return null; // 地址为空时不保存代理配置
            }

            const proxyConfig = {
                type: type,
                address: address
            };

            // 只有当用户名和密码都不为空时才添加认证信息
            if (username && password) {
                proxyConfig.username = username;
                proxyConfig.password = password;
            }

            return proxyConfig;
        }

        // 加载代理配置到表单
        function loadProxyConfig(config) {
            const checkbox = document.getElementById('proxy-enabled');
            const configDiv = document.getElementById('proxy-config');
            
            if (config) {
                checkbox.checked = true;
                configDiv.style.display = 'block';
                
                document.getElementById('proxy-type').value = config.type || 'http';
                document.getElementById('proxy-address').value = config.address || '';
                document.getElementById('proxy-username').value = config.username || '';
                document.getElementById('proxy-password').value = config.password || '';
            } else {
                checkbox.checked = false;
                configDiv.style.display = 'none';
                
                // 重置表单字段
                document.getElementById('proxy-type').value = 'http';
                document.getElementById('proxy-address').value = '';
                document.getElementById('proxy-username').value = '';
                document.getElementById('proxy-password').value = '';
            }
        }

        // 收集模型重写配置数据
        function collectModelRewriteData() {
            const enabled = document.getElementById('model-rewrite-enabled').checked;
            if (!enabled) {
                return null;
            }

            const rules = [];
            document.querySelectorAll('.rewrite-rule').forEach(ruleDiv => {
                const sourcePattern = ruleDiv.querySelector('.source-pattern-input').value.trim();
                const targetModel = ruleDiv.querySelector('.target-model-input').value.trim();
                
                if (sourcePattern && targetModel) {
                    rules.push({
                        source_pattern: sourcePattern,
                        target_model: targetModel
                    });
                }
            });

            return rules.length > 0 ? { enabled: true, rules: rules } : null;
        }

        // 加载模型重写配置到表单
        function loadModelRewriteConfig(config) {
            const checkbox = document.getElementById('model-rewrite-enabled');
            const rulesDiv = document.getElementById('model-rewrite-rules');
            const rulesList = document.getElementById('rewrite-rules-list');
            
            // 清空现有规则
            rulesList.innerHTML = '';
            
            if (config && config.enabled && config.rules) {
                checkbox.checked = true;
                rulesDiv.style.display = 'block';
                
                config.rules.forEach(rule => {
                    addRewriteRule(rule.source_pattern, rule.target_model);
                });
            } else {
                checkbox.checked = false;
                rulesDiv.style.display = 'none';
            }
        }

        // 保存模型重写配置
        function saveModelRewriteConfig(endpointName, config) {
            if (!config) return Promise.resolve();

            return fetch(`/admin/api/endpoints/${encodeURIComponent(endpointName)}/model-rewrite`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                return data;
            });
        }
    </script>

    {{template "footer.html" .}}
</body>
</html>