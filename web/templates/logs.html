<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .log-body {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        .log-body:hover {
            white-space: normal;
            word-break: break-all;
        }
        .save-file-btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            margin-top: 0.25rem;
        }
        .content-section {
            position: relative;
        }
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .json-pretty {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        /* Ê®°ÂûãÈáçÂÜôÁõ∏ÂÖ≥Ê†∑Âºè */
        .model-rewritten {
            position: relative;
            display: inline-block;
        }
        .model-rewritten::after {
            content: 'üîÑ';
            font-size: 0.7em;
            color: #28a745;
            margin-left: 3px;
        }
        .model-original {
            color: #6c757d;
        }
        /* TabÊ†∑Âºè */
        .before-after-tabs {
            margin-bottom: 1rem;
        }
        .before-after-tabs .nav-link {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        .comparison-badge {
            font-size: 0.7em;
            vertical-align: super;
            margin-left: 0.25rem;
        }
    </style>
</head>
<body>
    {{template "header.html" .}}

    <div class="container mt-4">
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ËØ∑Ê±ÇÊó•Âøó (ÂÖ± {{.Total}} Êù°){{if .FailedOnly}} - ‰ªÖÂ§±Ë¥•ËØ∑Ê±Ç{{end}}</h5>
                        <div>
                            <button class="btn btn-sm {{if .FailedOnly}}btn-warning{{else}}btn-outline-primary{{end}}" onclick="toggleFailedOnly()">
                                <i class="fas fa-filter"></i> {{if .FailedOnly}}ÊòæÁ§∫ÂÖ®ÈÉ®{{else}}‰ªÖÊòæÁ§∫Â§±Ë¥•{{end}}
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                                <i class="fas fa-refresh"></i> Âà∑Êñ∞
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {{if .FailedOnly}}
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-filter"></i> <strong>Á≠õÈÄâ‰∏≠Ôºö</strong> ‰ªÖÊòæÁ§∫Â§±Ë¥•ËØ∑Ê±ÇÔºàÁä∂ÊÄÅÁ†Å ‚â• 400 ÊàñÈîôËØØÔºâ
                        </div>
                        {{end}}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Êó∂Èó¥</th>
                                        <th>ËØ∑Ê±ÇID</th>
                                        <th>Á´ØÁÇπ</th>
                                        <th>Ê®°Âûã</th>
                                        <th>Tags</th>
                                        <th>Áä∂ÊÄÅ</th>
                                        <th>ËÄóÊó∂</th>
                                        <th>ËØ∑Ê±ÇÂ§ßÂ∞è</th>
                                        <th>ÂìçÂ∫îÂ§ßÂ∞è</th>
                                        <th>ÊµÅÂºè</th>
                                        <th>Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{range .Logs}}
                                    <tr>
                                        <td>{{.Timestamp.Format "15:04:05"}}</td>
                                        <td><small>{{.RequestID}}</small></td>
                                        <td><small>{{.Endpoint}}</small></td>
                                        <td>
                                            <small>
                                                {{if .Model}}
                                                    {{if .ModelRewriteApplied}}
                                                        <span class="model-rewritten" 
                                                              data-bs-toggle="tooltip" 
                                                              data-bs-placement="top" 
                                                              title="‚Üí {{.RewrittenModel}}">
                                                            {{.Model}}
                                                        </span>
                                                    {{else}}
                                                        <span class="model-original">{{.Model}}</span>
                                                    {{end}}
                                                {{else}}
                                                    -
                                                {{end}}
                                            </small>
                                        </td>
                                        <td>
                                            {{if .Tags}}
                                                {{range $i, $tag := .Tags}}
                                                    <span class="badge bg-primary me-1">{{$tag}}</span>
                                                {{end}}
                                            {{else}}
                                                <small class="text-muted">-</small>
                                            {{end}}
                                        </td>
                                        <td>
                                            {{if lt .StatusCode 400}}
                                                <span class="badge bg-success">{{.StatusCode}}</span>
                                            {{else}}
                                                <span class="badge bg-danger">{{.StatusCode}}</span>
                                            {{end}}
                                        </td>
                                        <td class="duration-cell" data-ms="{{.DurationMs}}">{{.DurationMs}}ms</td>
                                        <td><small class="filesize-cell" data-bytes="{{.RequestBodySize}}">{{.RequestBodySize}}B</small></td>
                                        <td><small class="filesize-cell" data-bytes="{{.ResponseBodySize}}">{{.ResponseBodySize}}B</small></td>
                                        <td>
                                            {{if .IsStreaming}}
                                                <span class="badge bg-info">SSE</span>
                                                {{if .ContentTypeOverride}}
                                                    <i class="fas fa-sync-alt ms-1" 
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="top" 
                                                       title="Content-Type Ë¶ÜÁõñ: ÂéüÂßãÁ±ªÂûã ‚Üí {{.ContentTypeOverride}}"
                                                       style="color: #28a745; font-size: 0.7em;"></i>
                                                {{end}}
                                            {{else}}
                                                <span class="badge bg-secondary">JSON</span>
                                                {{if .ContentTypeOverride}}
                                                    <i class="fas fa-sync-alt ms-1" 
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="top" 
                                                       title="Content-Type Ë¶ÜÁõñ: ÂéüÂßãÁ±ªÂûã ‚Üí {{.ContentTypeOverride}}"
                                                       style="color: #28a745; font-size: 0.7em;"></i>
                                                {{end}}
                                            {{end}}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" onclick="showLogDetails('{{.RequestID}}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        {{if gt .TotalPages 1}}
                        <nav aria-label="Logs pagination">
                            <ul class="pagination pagination-sm justify-content-center">
                                {{if .HasPrev}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{.PrevPage}}&failed_only={{.FailedOnly}}">‰∏ä‰∏ÄÈ°µ</a>
                                </li>
                                {{else}}
                                <li class="page-item disabled">
                                    <span class="page-link">‰∏ä‰∏ÄÈ°µ</span>
                                </li>
                                {{end}}
                                
                                {{range .Pages}}
                                {{if eq . $.Page}}
                                <li class="page-item active">
                                    <span class="page-link">{{.}}</span>
                                </li>
                                {{else}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{.}}&failed_only={{$.FailedOnly}}">{{.}}</a>
                                </li>
                                {{end}}
                                {{end}}
                                
                                {{if .HasNext}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{.NextPage}}&failed_only={{.FailedOnly}}">‰∏ã‰∏ÄÈ°µ</a>
                                </li>
                                {{else}}
                                <li class="page-item disabled">
                                    <span class="page-link">‰∏ã‰∏ÄÈ°µ</span>
                                </li>
                                {{end}}
                            </ul>
                        </nav>
                        
                        <div class="text-center text-muted small mt-2">
                            Á¨¨ {{.Page}} / {{.TotalPages}} È°µÔºåÂÖ± {{.Total}} Êù°ËÆ∞ÂΩïÔºåÊØèÈ°µÊòæÁ§∫ {{.Limit}} Êù°
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for log details -->
    <div class="modal fade" id="logModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ËØ∑Ê±ÇËØ¶ÊÉÖ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Ëé∑ÂèñÂΩìÂâçÁä∂ÊÄÅ
        let failedOnly = {{.FailedOnly}};
        let currentPage = {{.Page}};
        
        function formatDuration(ms) {
            return (ms / 1000).toFixed(3) + 's';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0B';
            if (bytes < 1024) return bytes + 'B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
            return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
        }
        
        // Format cells after page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Format duration cells
            document.querySelectorAll('.duration-cell').forEach(function(cell) {
                const ms = parseInt(cell.getAttribute('data-ms'));
                cell.textContent = formatDuration(ms);
            });
            
            // Format file size cells
            document.querySelectorAll('.filesize-cell').forEach(function(cell) {
                const bytes = parseInt(cell.getAttribute('data-bytes'));
                cell.textContent = formatFileSize(bytes);
            });
            
            // Initialize Bootstrap tooltips for model rewrite indicators
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
        
        function toggleFailedOnly() {
            failedOnly = !failedOnly;
            window.location.href = `/admin/logs?page=1&failed_only=${failedOnly}`;
        }
        
        function refreshLogs() {
            window.location.href = `/admin/logs?page=${currentPage}&failed_only=${failedOnly}`;
        }

        function showLogDetails(requestId) {
            fetch(`/admin/api/logs?request_id=${requestId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        displayMultipleLogDetails(data.logs);
                    }
                })
                .catch(error => {
                    console.error('Error fetching log details:', error);
                });
        }

        function displayMultipleLogDetails(logs) {
            const modalBody = document.getElementById('modalBody');
            
            if (logs.length === 1) {
                displayLogDetails(logs[0]);
                return;
            }
            
            let html = `<div class="row mb-3">
                <div class="col-12">
                    <h6>ËØ∑Ê±ÇËØ¶ÊÉÖ - ${logs.length} Ê¨°Â∞ùËØï</h6>
                    <div class="alert alert-info">
                        <strong>ËØ∑Ê±ÇID:</strong> ${escapeHtml(logs[0].request_id)}<br>
                        <strong>Ë∑ØÂæÑ:</strong> ${escapeHtml(logs[0].path)}<br>
                        <strong>ËØ∑Ê±ÇÊñπÊ≥ï:</strong> ${escapeHtml(logs[0].method)}<br>
                        <strong>ÊÄªËÄóÊó∂:</strong> ${logs.reduce((sum, log) => sum + log.duration_ms, 0)}ms
                    </div>
                </div>
            </div>`;
            
            logs.forEach((log, index) => {
                html += generateLogAttemptHtml(log, index + 1);
            });
            
            modalBody.innerHTML = html;
            
            // ÈáçÊñ∞ÂàùÂßãÂåñtooltips for dynamic content
            var tooltipTriggerList = [].slice.call(modalBody.querySelectorAll('[title]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            const modal = new bootstrap.Modal(document.getElementById('logModal'));
            modal.show();
        }

        function generateLogAttemptHtml(log, attemptNum) {
            const isSuccess = log.status_code >= 200 && log.status_code < 300;
            const badgeClass = isSuccess ? 'bg-success' : 'bg-danger';
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊï∞ÊçÆËΩ¨Êç¢
            const requestChanges = hasRequestChanges(log);
            const responseChanges = hasResponseChanges(log);
            
            return `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    Â∞ùËØï ${attemptNum}: ${escapeHtml(log.endpoint)} 
                                    <span class="badge ${badgeClass}">${log.status_code}</span>
                                    <span class="badge bg-secondary">${log.duration_ms}ms</span>
                                    ${log.model ? 
                                        (log.model_rewrite_applied ? 
                                            `<span class="badge bg-success model-rewritten" title="‚Üí ${escapeHtml(log.rewritten_model)}">${escapeHtml(log.model)}</span>` :
                                            `<span class="badge bg-primary">${escapeHtml(log.model)}</span>`
                                        ) : ''
                                    }
                                    ${log.is_streaming ? '<span class="badge bg-info">SSE</span>' : ''}
                                    ${log.content_type_override ? `<span class="badge bg-warning text-dark" title="Content-TypeË¶ÜÁõñ: ${escapeHtml(log.content_type_override)}">${escapeHtml(log.content_type_override)}</span>` : ''}
                                    ${requestChanges || responseChanges ? '<span class="badge bg-info">Êúâ‰øÆÊîπ</span>' : ''}
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Request/Response Tabs -->
                                <ul class="nav nav-tabs before-after-tabs" id="logTabs${attemptNum}" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="request-tab-${attemptNum}" data-bs-toggle="tab" data-bs-target="#request-${attemptNum}" type="button" role="tab">
                                            ËØ∑Ê±ÇÊï∞ÊçÆ ${requestChanges ? '<span class="comparison-badge badge bg-warning">‰øÆÊîπ</span>' : ''}
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="response-tab-${attemptNum}" data-bs-toggle="tab" data-bs-target="#response-${attemptNum}" type="button" role="tab">
                                            ÂìçÂ∫îÊï∞ÊçÆ ${responseChanges ? '<span class="comparison-badge badge bg-warning">‰øÆÊîπ</span>' : ''}
                                        </button>
                                    </li>
                                </ul>
                                
                                <div class="tab-content mt-3" id="logTabsContent${attemptNum}">
                                    <!-- Request Tab -->
                                    <div class="tab-pane fade show active" id="request-${attemptNum}" role="tabpanel">
                                        ${generateRequestComparisonHtml(log, attemptNum)}
                                    </div>
                                    
                                    <!-- Response Tab -->  
                                    <div class="tab-pane fade" id="response-${attemptNum}" role="tabpanel">
                                        ${generateResponseComparisonHtml(log, attemptNum)}
                                    </div>
                                </div>
                                
                                ${log.error ? `<div class="row mt-3"><div class="col-12"><div class="alert alert-danger"><strong>ÈîôËØØ:</strong> ${escapeHtml(log.error)}</div></div></div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function generateRequestComparisonHtml(log, attemptNum) {
            const hasUrlChanges = log.original_request_url && log.final_request_url && log.original_request_url !== log.final_request_url;
            const hasHeaderChanges = log.original_request_headers && log.final_request_headers && 
                                   JSON.stringify(log.original_request_headers) !== JSON.stringify(log.final_request_headers);
            const hasBodyChanges = log.original_request_body && log.final_request_body && log.original_request_body !== log.final_request_body;
            
            let html = '';
            
            // URLÂØπÊØîÔºàÂ¶ÇÊûúÊúâÂèòÂåñÔºâ
            if (hasUrlChanges) {
                html += `
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6>URL ÂØπÊØî</h6>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">ÂÆ¢Êà∑Á´ØÂéüÂßã URL:</small>
                                    <div class="json-pretty" style="max-height: 100px;">${escapeHtml(log.original_request_url || '-')}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-success">ÂèëÈÄÅÁªô‰∏äÊ∏∏ URL:</small>
                                    <div class="json-pretty" style="max-height: 100px;">${escapeHtml(log.final_request_url || log.original_request_url || '-')}</div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
            
            // Headers ÂØπÊØî
            html += `
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="content-section">
                            <div class="content-header">
                                <h6>ËØ∑Ê±ÇÂ§¥ÂØπÊØî ${hasHeaderChanges ? '<span class="badge bg-warning">Êúâ‰øÆÊîπ</span>' : ''}</h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn me-1" 
                                            data-filename="ÂéüÂßãËØ∑Ê±ÇÂ§¥_${log.request_id}_Â∞ùËØï${attemptNum}.json"
                                            data-content="${safeBase64Encode(JSON.stringify(log.original_request_headers || {}, null, 2))}"
                                            onclick="saveAsFileFromButton(this)">
                                        <i class="fas fa-download"></i> ÂéüÂßã
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                            data-filename="ÊúÄÁªàËØ∑Ê±ÇÂ§¥_${log.request_id}_Â∞ùËØï${attemptNum}.json"
                                            data-content="${safeBase64Encode(JSON.stringify(log.final_request_headers || log.request_headers || {}, null, 2))}"
                                            onclick="saveAsFileFromButton(this)">
                                        <i class="fas fa-download"></i> ÊúÄÁªà
                                    </button>
                                </div>
                            </div>
                            ${hasHeaderChanges ? `
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">ÂÆ¢Êà∑Á´ØÂéüÂßãËØ∑Ê±ÇÂ§¥:</small>
                                        <div class="json-pretty" style="max-height: 300px;">${escapeHtml(formatJson(JSON.stringify(log.original_request_headers || {}, null, 2)))}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-success">ÂèëÈÄÅÁªô‰∏äÊ∏∏ËØ∑Ê±ÇÂ§¥:</small>
                                        <div class="json-pretty" style="max-height: 300px;">${escapeHtml(formatJson(JSON.stringify(log.final_request_headers || log.request_headers || {}, null, 2)))}</div>
                                    </div>
                                </div>
                            ` : `
                                <div class="json-pretty" style="max-height: 300px;">${escapeHtml(formatJson(JSON.stringify(log.request_headers || {}, null, 2)))}</div>
                            `}
                        </div>
                    </div>
                </div>`;
            
            // Body ÂØπÊØî
            html += `
                <div class="row">
                    <div class="col-12">
                        <div class="content-section">
                            <div class="content-header">
                                <h6>ËØ∑Ê±Ç‰ΩìÂØπÊØî (${log.request_body_size} Â≠óËäÇ) ${hasBodyChanges ? '<span class="badge bg-warning">Êúâ‰øÆÊîπ</span>' : ''}</h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn me-1" 
                                            data-filename="ÂéüÂßãËØ∑Ê±Ç‰Ωì_${log.request_id}_Â∞ùËØï${attemptNum}.${getFileExtension(log.original_request_body)}"
                                            data-content="${log.original_request_body ? safeBase64Encode(log.original_request_body) : ''}"
                                            onclick="saveAsFileFromButton(this)" 
                                            ${!log.original_request_body ? 'disabled' : ''}>
                                        <i class="fas fa-download"></i> ÂéüÂßã
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                            data-filename="ÊúÄÁªàËØ∑Ê±Ç‰Ωì_${log.request_id}_Â∞ùËØï${attemptNum}.${getFileExtension(log.final_request_body || log.request_body)}"
                                            data-content="${(log.final_request_body || log.request_body) ? safeBase64Encode(log.final_request_body || log.request_body) : ''}"
                                            onclick="saveAsFileFromButton(this)" 
                                            ${!(log.final_request_body || log.request_body) ? 'disabled' : ''}>
                                        <i class="fas fa-download"></i> ÊúÄÁªà
                                    </button>
                                </div>
                            </div>
                            ${hasBodyChanges ? `
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">ÂÆ¢Êà∑Á´ØÂéüÂßãËØ∑Ê±Ç‰Ωì:</small>
                                        <div class="json-pretty" style="max-height: 400px;">
                                            ${log.original_request_body ? escapeHtml(formatJson(log.original_request_body)) : 'Êó†ËØ∑Ê±Ç‰Ωì'}
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-success">ÂèëÈÄÅÁªô‰∏äÊ∏∏ËØ∑Ê±Ç‰Ωì:</small>
                                        <div class="json-pretty" style="max-height: 400px;">
                                            ${(log.final_request_body || log.request_body) ? escapeHtml(formatJson(log.final_request_body || log.request_body)) : 'Êó†ËØ∑Ê±Ç‰Ωì'}
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="json-pretty" style="max-height: 400px;">
                                    ${log.request_body ? escapeHtml(formatJson(log.request_body)) : 'Êó†ËØ∑Ê±Ç‰Ωì'}
                                </div>
                            `}
                        </div>
                    </div>
                </div>`;
            
            return html;
        }

        function generateResponseComparisonHtml(log, attemptNum) {
            const hasHeaderChanges = log.original_response_headers && log.final_response_headers && 
                                   JSON.stringify(log.original_response_headers) !== JSON.stringify(log.final_response_headers);
            const hasBodyChanges = log.original_response_body && log.final_response_body && log.original_response_body !== log.final_response_body;
            
            let html = '';
            
            // Headers ÂØπÊØî
            html += `
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="content-section">
                            <div class="content-header">
                                <h6>ÂìçÂ∫îÂ§¥ÂØπÊØî ${hasHeaderChanges ? '<span class="badge bg-warning">Êúâ‰øÆÊîπ</span>' : ''}</h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn me-1" 
                                            data-filename="ÂéüÂßãÂìçÂ∫îÂ§¥_${log.request_id}_Â∞ùËØï${attemptNum}.json"
                                            data-content="${safeBase64Encode(JSON.stringify(log.original_response_headers || {}, null, 2))}"
                                            onclick="saveAsFileFromButton(this)">
                                        <i class="fas fa-download"></i> ÂéüÂßã
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                            data-filename="ÊúÄÁªàÂìçÂ∫îÂ§¥_${log.request_id}_Â∞ùËØï${attemptNum}.json"
                                            data-content="${safeBase64Encode(JSON.stringify(log.final_response_headers || log.response_headers || {}, null, 2))}"
                                            onclick="saveAsFileFromButton(this)">
                                        <i class="fas fa-download"></i> ÊúÄÁªà
                                    </button>
                                </div>
                            </div>
                            ${hasHeaderChanges ? `
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">‰∏äÊ∏∏ÂéüÂßãÂìçÂ∫îÂ§¥:</small>
                                        <div class="json-pretty" style="max-height: 300px;">${escapeHtml(formatJson(JSON.stringify(log.original_response_headers || {}, null, 2)))}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-success">ÂèëÈÄÅÁªôÂÆ¢Êà∑Á´ØÂìçÂ∫îÂ§¥:</small>
                                        <div class="json-pretty" style="max-height: 300px;">${escapeHtml(formatJson(JSON.stringify(log.final_response_headers || log.response_headers || {}, null, 2)))}</div>
                                    </div>
                                </div>
                            ` : `
                                <div class="json-pretty" style="max-height: 300px;">${escapeHtml(formatJson(JSON.stringify(log.response_headers || {}, null, 2)))}</div>
                            `}
                        </div>
                    </div>
                </div>`;
            
            // Body ÂØπÊØî
            html += `
                <div class="row">
                    <div class="col-12">
                        <div class="content-section">
                            <div class="content-header">
                                <h6>ÂìçÂ∫î‰ΩìÂØπÊØî (${log.response_body_size} Â≠óËäÇ) ${hasBodyChanges ? '<span class="badge bg-warning">Êúâ‰øÆÊîπ</span>' : ''}</h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn me-1" 
                                            data-filename="ÂéüÂßãÂìçÂ∫î‰Ωì_${log.request_id}_Â∞ùËØï${attemptNum}.${getFileExtension(log.original_response_body)}"
                                            data-content="${log.original_response_body ? safeBase64Encode(log.original_response_body) : ''}"
                                            onclick="saveAsFileFromButton(this)" 
                                            ${!log.original_response_body ? 'disabled' : ''}>
                                        <i class="fas fa-download"></i> ÂéüÂßã
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary save-file-btn" 
                                            data-filename="ÊúÄÁªàÂìçÂ∫î‰Ωì_${log.request_id}_Â∞ùËØï${attemptNum}.${getFileExtension(log.final_response_body || log.response_body)}"
                                            data-content="${(log.final_response_body || log.response_body) ? safeBase64Encode(log.final_response_body || log.response_body) : ''}"
                                            onclick="saveAsFileFromButton(this)" 
                                            ${!(log.final_response_body || log.response_body) ? 'disabled' : ''}>
                                        <i class="fas fa-download"></i> ÊúÄÁªà
                                    </button>
                                </div>
                            </div>
                            ${hasBodyChanges ? `
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">‰∏äÊ∏∏ÂéüÂßãÂìçÂ∫î‰Ωì:</small>
                                        <div class="json-pretty" style="max-height: 400px;">
                                            ${log.original_response_body ? escapeHtml(formatJson(log.original_response_body)) : 'Êó†ÂìçÂ∫î‰Ωì'}
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-success">ÂèëÈÄÅÁªôÂÆ¢Êà∑Á´ØÂìçÂ∫î‰Ωì:</small>
                                        <div class="json-pretty" style="max-height: 400px;">
                                            ${(log.final_response_body || log.response_body) ? escapeHtml(formatJson(log.final_response_body || log.response_body)) : 'Êó†ÂìçÂ∫î‰Ωì'}
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="json-pretty" style="max-height: 400px;">
                                    ${log.response_body ? escapeHtml(formatJson(log.response_body)) : 'Êó†ÂìçÂ∫î‰Ωì'}
                                </div>
                            `}
                        </div>
                    </div>
                </div>`;
            
            return html;
        }

        function hasDataChanges(originalUrl, originalHeaders, originalBody, finalUrl, finalHeaders, finalBody) {
            // Ê£ÄÊü•URLÂèòÂåñ
            if (originalUrl && finalUrl && originalUrl !== finalUrl) return true;
            
            // Ê£ÄÊü•headersÂèòÂåñ
            if (originalHeaders && finalHeaders) {
                if (JSON.stringify(originalHeaders) !== JSON.stringify(finalHeaders)) return true;
            }
            
            // Ê£ÄÊü•bodyÂèòÂåñ
            if (originalBody && finalBody && originalBody !== finalBody) return true;
            
            return false;
        }

        function hasRequestChanges(log) {
            const hasUrlChanges = log.original_request_url && log.final_request_url && log.original_request_url !== log.final_request_url;
            const hasHeaderChanges = log.original_request_headers && log.final_request_headers && 
                                   JSON.stringify(log.original_request_headers) !== JSON.stringify(log.final_request_headers);
            const hasBodyChanges = log.original_request_body && log.final_request_body && log.original_request_body !== log.final_request_body;
            
            return hasUrlChanges || hasHeaderChanges || hasBodyChanges;
        }
        
        function hasResponseChanges(log) {
            const hasHeaderChanges = log.original_response_headers && log.final_response_headers && 
                                   JSON.stringify(log.original_response_headers) !== JSON.stringify(log.final_response_headers);
            const hasBodyChanges = log.original_response_body && log.final_response_body && log.original_response_body !== log.final_response_body;
            
            return hasHeaderChanges || hasBodyChanges;
        }

        function displayLogDetails(log) {
            const modalBody = document.getElementById('modalBody');
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊï∞ÊçÆËΩ¨Êç¢
            const requestChanges = hasRequestChanges(log);
            const responseChanges = hasResponseChanges(log);

            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-12 mb-3">
                        <h6>Âü∫Êú¨‰ø°ÊÅØ</h6>
                        <table class="table table-sm">
                            <tr><th>ËØ∑Ê±ÇID:</th><td>${escapeHtml(log.request_id)}</td></tr>
                            <tr><th>Êó∂Èó¥Êà≥:</th><td>${new Date(log.timestamp).toLocaleString()}</td></tr>
                            <tr><th>Á´ØÁÇπ:</th><td>${escapeHtml(log.endpoint)}</td></tr>
                            <tr><th>ËØ∑Ê±ÇÊñπÊ≥ï:</th><td>${escapeHtml(log.method)}</td></tr>
                            <tr><th>Ë∑ØÂæÑ:</th><td>${escapeHtml(log.path)}</td></tr>
                            <tr><th>Áä∂ÊÄÅÁ†Å:</th><td>${log.status_code}</td></tr>
                            <tr><th>Ê®°Âûã:</th><td>
                                ${log.model ? 
                                    (log.model_rewrite_applied ? 
                                        `<span class="model-rewritten" title="‚Üí ${escapeHtml(log.rewritten_model)}">${escapeHtml(log.model)}</span>` : 
                                        `<span class="model-original">${escapeHtml(log.model)}</span>`
                                    ) : 
                                    '<small class="text-muted">Êó†</small>'
                                }
                            </td></tr>
                            <tr><th>ËÄóÊó∂:</th><td>${log.duration_ms}ms</td></tr>
                            <tr><th>ËØ∑Ê±Ç‰ΩìÂ§ßÂ∞è:</th><td>${log.request_body_size} Â≠óËäÇ</td></tr>
                            <tr><th>ÂìçÂ∫î‰ΩìÂ§ßÂ∞è:</th><td>${log.response_body_size} Â≠óËäÇ</td></tr>
                            <tr><th>ÊµÅÂºèÂìçÂ∫î:</th><td>${log.is_streaming ? 'ÊòØ (SSE)' : 'Âê¶'}</td></tr>
                            <tr><th>Tags:</th><td>${log.tags && log.tags.length > 0 ? log.tags.map(tag => `<span class="badge bg-primary me-1">${escapeHtml(tag)}</span>`).join('') : '<small class="text-muted">Êó†</small>'}</td></tr>
                            <tr><th>Content-TypeË¶ÜÁõñ:</th><td>${log.content_type_override ? `<span class="badge bg-warning text-dark">${escapeHtml(log.content_type_override)}</span>` : '<small class="text-muted">Êó†</small>'}</td></tr>
                            ${log.error ? `<tr><th>ÈîôËØØ:</th><td class="text-danger">${escapeHtml(log.error)}</td></tr>` : ''}
                        </table>
                    </div>
                </div>
                
                <!-- Request/Response Tabs -->
                <ul class="nav nav-tabs before-after-tabs" id="singleLogTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="single-request-tab" data-bs-toggle="tab" data-bs-target="#single-request" type="button" role="tab">
                            ËØ∑Ê±ÇÊï∞ÊçÆ ${requestChanges ? '<span class="comparison-badge badge bg-warning">‰øÆÊîπ</span>' : ''}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="single-response-tab" data-bs-toggle="tab" data-bs-target="#single-response" type="button" role="tab">
                            ÂìçÂ∫îÊï∞ÊçÆ ${responseChanges ? '<span class="comparison-badge badge bg-warning">‰øÆÊîπ</span>' : ''}
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="singleLogTabsContent">
                    <!-- Request Tab -->
                    <div class="tab-pane fade show active" id="single-request" role="tabpanel">
                        ${generateRequestComparisonHtml(log, 'single')}
                    </div>
                    
                    <!-- Response Tab -->  
                    <div class="tab-pane fade" id="single-response" role="tabpanel">
                        ${generateResponseComparisonHtml(log, 'single')}
                    </div>
                </div>
            `;
            
            // ÈáçÊñ∞ÂàùÂßãÂåñtooltips for dynamic content
            var tooltipTriggerList = [].slice.call(modalBody.querySelectorAll('[title]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            const modal = new bootstrap.Modal(document.getElementById('logModal'));
            modal.show();
        }

        function formatJson(jsonString) {
            if (!jsonString) return jsonString;
            try {
                const parsed = JSON.parse(jsonString);
                return JSON.stringify(parsed, null, 2);
            } catch {
                return jsonString;
            }
        }

        // UTF-8ÂÆâÂÖ®ÁöÑBase64ÁºñÁ†Å
        function safeBase64Encode(str) {
            try {
                // È¶ñÂÖàÈÄöËøáencodeURIComponentÂ§ÑÁêÜUTF-8Â≠óÁ¨¶ÔºåÁÑ∂ÂêéËøõË°åBase64ÁºñÁ†Å
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
            } catch (error) {
                console.warn('Base64ÁºñÁ†ÅÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ≥ï:', error);
                // Â§áÁî®ÊñπÊ≥ïÔºöÁõ¥Êé•‰ΩøÁî®encodeURIComponent
                return encodeURIComponent(str);
            }
        }

        // UTF-8ÂÆâÂÖ®ÁöÑBase64Ëß£Á†Å
        function safeBase64Decode(str) {
            try {
                // È¶ñÂÖàÂ∞ùËØïÊ†áÂáÜBase64Ëß£Á†Å
                const decoded = atob(str);
                return decodeURIComponent(Array.prototype.map.call(decoded, function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            } catch (error) {
                console.warn('Base64Ëß£Á†ÅÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ≥ï:', error);
                // Â§áÁî®ÊñπÊ≥ïÔºöÁõ¥Êé•‰ΩøÁî®decodeURIComponent
                try {
                    return decodeURIComponent(str);
                } catch (e) {
                    console.error('ÊâÄÊúâËß£Á†ÅÊñπÊ≥ïÈÉΩÂ§±Ë¥•:', e);
                    return str; // ËøîÂõûÂéüÂßãÂ≠óÁ¨¶‰∏≤
                }
            }
        }
        
        function escapeHtml(text) {
            if (!text) return text;
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Ê†πÊçÆÂÜÖÂÆπÂà§Êñ≠Êñá‰ª∂Êâ©Â±ïÂêç
        function getFileExtension(content) {
            if (!content) return 'txt';
            
            try {
                JSON.parse(content);
                return 'json';
            } catch {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØSSEÊ†ºÂºè
                if (content.includes('event: ') && content.includes('data: ')) {
                    return 'sse';
                }
                return 'txt';
            }
        }

        // ‰øùÂ≠òÊñá‰ª∂ÂäüËÉΩ - ‰ªéÊåâÈíÆÁöÑdataÂ±ûÊÄßËØªÂèñÂÜÖÂÆπ
        function saveAsFileFromButton(button) {
            const filename = button.getAttribute('data-filename');
            const encodedContent = button.getAttribute('data-content');
            
            if (!encodedContent || encodedContent.trim() === '') {
                alert('ÂÜÖÂÆπ‰∏∫Á©∫ÔºåÊó†Ê≥ï‰øùÂ≠ò');
                return;
            }

            try {
                // ‰ΩøÁî®UTF-8ÂÆâÂÖ®ÁöÑËß£Á†ÅÊñπÊ≥ï
                const content = safeBase64Decode(encodedContent);
                
                // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                // ÂàõÂª∫‰∏ãËΩΩÂÖÉÁ¥†
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = filename;
                downloadLink.style.display = 'none';
                
                // Ê∑ªÂä†Âà∞DOMÂπ∂Ëß¶Âèë‰∏ãËΩΩ
                document.body.appendChild(downloadLink);
                downloadLink.click();
                
                // Ê∏ÖÁêÜ
                setTimeout(() => {
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                }, 100);
            } catch (error) {
                console.error('‰øùÂ≠òÊñá‰ª∂Â§±Ë¥•:', error);
                alert('‰øùÂ≠òÊñá‰ª∂Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ÊéßÂà∂Âè∞');
            }
        }
    </script>

    {{template "footer.html" .}}
</body>
</html>