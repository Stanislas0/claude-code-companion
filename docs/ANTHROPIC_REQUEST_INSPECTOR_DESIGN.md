# Anthropic 请求检查器设计文档

## 概述

为日志查看器添加一个 Anthropic 请求检查器功能，通过解析和结构化展示请求内容，帮助用户更好地分析和理解 API 请求的详细信息。

## 功能入口

- **位置**: 日志详情弹窗 → 原始请求体编辑框 → 工具栏
- **触发**: 新增"🔍 检查请求"按钮
- **条件**: 仅当请求体包含有效的 Anthropic API 格式时显示

## 界面布局设计

### 主窗口结构
```
┌─────────────────────────────────────────────────────────┐
│ Anthropic 请求检查器                            [✕]    │
├─────────────────────────────────────────────────────────┤
│ 📊 请求概览                                            │
│   模型: claude-3-sonnet-20240229                        │
│   最大令牌: 4096                                        │
│   消息数: 5                                             │
│   工具数: 12                                            │
├─────────────────────────────────────────────────────────┤
│ 🔧 系统配置                                    [展开/折叠] │
│ ├─ 📝 System Prompt (2156 字符)               [展开/折叠] │
│ └─ 🛠️  可用工具 (12个)                         [展开/折叠] │
│     ├─ 📁 Read - 读取文件                               │
│     ├─ ✏️  Edit - 编辑文件                               │
│     ├─ 🔍 Grep - 搜索内容                               │
│     └─ ... (点击展开显示更多)                            │
├─────────────────────────────────────────────────────────┤
│ 💬 对话消息                                             │
│ ├─ [1] 👤 User                                          │
│ │   ├─ 💭 正文内容 (显示前100字符...)                     │
│ │   └─ ⚠️  System Reminder (3个)                [展开/折叠] │
│ ├─ [2] 🤖 Assistant                                     │
│ │   ├─ 💭 回复内容 (显示前100字符...)                     │
│ │   └─ 🔧 工具调用 (4次)                        [展开/折叠] │
│ │       ├─ 📁 Read("file.go") → ✅ 成功 (1024字符)       │
│ │       ├─ 🔍 Grep("func.*main") → ✅ 5个匹配            │
│ │       ├─ ✏️  Edit("file.go") → ✅ 修改完成              │
│ │       └─ 🧠 Thinking → 💭 思考内容...                  │
│ └─ [3] 👤 User                                          │
│     └─ 💭 "请继续..."                                   │
└─────────────────────────────────────────────────────────┘
```

## 详细功能设计

### 1. 请求概览区域
显示请求的基本统计信息：
- 使用的模型名称
- max_tokens 设置
- 消息总数
- 可用工具数量
- 预估 token 消耗（如果能计算）

### 2. 系统配置区域

#### System Prompt 展示
- **折叠状态**: 显示字符数和开头片段
- **展开状态**: 完整显示，支持语法高亮和搜索

#### 工具列表展示
- **折叠状态**: 仅显示工具数量和名称列表
- **展开状态**: 显示工具详细信息

**工具详情格式:**
```
🔧 工具名称 - 一行描述
├─ 📋 参数列表
│   ├─ param1 (string, required) - 参数描述
│   ├─ param2 (number, optional) - 参数描述  
│   └─ ...
└─ 📖 完整描述 [展开/折叠]
```

### 3. 对话消息区域

#### User 消息展示
```
[消息序号] 👤 User
├─ 💭 正文内容
│   └─ [前100字符预览...] [展开查看全部]
└─ ⚠️ System Reminders (如果存在)
    ├─ [1] 📌 提醒类型: 内容预览... [展开]
    ├─ [2] 🔄 上下文: 内容预览... [展开]  
    └─ [3] ⚡ 工具提示: 内容预览... [展开]
```

#### Assistant 消息展示
```
[消息序号] 🤖 Assistant  
├─ 💭 回复内容
│   └─ [内容预览...] [展开查看全部]
└─ 🔧 工具使用记录 (X次调用)
    ├─ [调用1] 📁 Read → ✅ 结果预览 [详情]
    ├─ [调用2] 🧠 Thinking → 💭 [详情] 
    ├─ [调用3] ✏️ Edit → ❌ 错误信息 [详情]
    └─ ...
```

#### 工具调用详情弹窗
点击工具调用的"详情"按钮时展开：
```
┌─────────────────────────────────────────┐
│ 🔧 Read 工具调用详情                   │
├─────────────────────────────────────────┤
│ 📤 调用参数:                           │
│ {                                       │
│   "file_path": "/path/to/file.go",     │
│   "limit": 100                         │
│ }                                       │
├─────────────────────────────────────────┤  
│ 📥 返回结果: [展开/折叠]                │
│ 状态: ✅ 成功 (1024 字符)               │
│ [结果内容预览...]                       │
└─────────────────────────────────────────┘
```

## 特殊处理逻辑

### 1. Tool Use 和 Tool Result 配对
- 通过 `id` 字段自动匹配 tool_use 和 tool_result
- 按时间顺序展示工具调用序列
- 未匹配的调用显示为"等待结果"状态

### 2. Thinking 内容处理
- 标识为 `🧠 Thinking`
- 默认折叠显示
- 支持语法高亮（如果内容包含代码）

### 3. 长内容处理
- 超过指定长度的内容自动折叠
- 提供字符计数显示
- 支持关键词搜索和高亮

### 4. 错误处理
- 解析失败时显示原始 JSON
- 部分字段缺失时使用默认值
- 提供"重新解析"功能

## 技术实现要点

### 前端实现
- 使用递归展开/折叠组件
- JSON 解析和验证
- 语法高亮支持
- 响应式布局

### 数据解析
- 严格按照 Anthropic API 格式解析
- 支持不同版本的消息格式
- 工具 schema 解析和展示

### 性能优化
- 大内容延迟渲染
- 虚拟滚动（如果消息很多）
- 缓存解析结果

## 扩展功能建议

### 1. 分析功能
- Token 使用量估算
- 工具调用效率分析
- 对话流程可视化

### 2. 导出功能
- 导出为结构化文档
- 生成调用摘要
- 复制特定部分内容

### 3. 搜索功能
- 跨消息搜索关键词
- 按工具类型筛选
- 按消息角色筛选

## 用户体验考虑

1. **直观性**: 使用图标和颜色区分不同类型的内容
2. **层次性**: 通过缩进和折叠保持清晰的层次结构
3. **响应性**: 大内容加载时显示进度提示
4. **可操作性**: 支持复制、搜索、导出等常用操作

这个设计能帮助您更好地分析 Anthropic 请求吗？有什么需要调整或补充的地方？